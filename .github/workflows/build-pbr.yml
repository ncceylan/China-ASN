name: Build PBR

on:
  push:
    paths:
      - 'asn_*.conf'  # å½“ASNæ–‡ä»¶å˜æ›´æ—¶è§¦å‘
      - 'ros-dpbr.sh'  # å½“è„šæœ¬å˜æ›´æ—¶è§¦å‘
  schedule:
    - cron: "2 0/1 * * *"
  workflow_dispatch:
  # å…è®¸è¢«ASNæ›´æ–°å·¥ä½œæµè§¦å‘
  workflow_call:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Verify ASN files exist
      run: |
        echo "ğŸ” æ£€æŸ¥ASNæ–‡ä»¶:"
        ls -la *.conf || echo "æœªæ‰¾åˆ°.confæ–‡ä»¶"
        for file in asn_cn.conf asn_ct.conf asn_cmcc.conf; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "âœ… $file: $lines è¡Œ"
          else
            echo "âŒ $file: æ–‡ä»¶ä¸å­˜åœ¨"
          fi
        done

    - name: Download CIDR and build PBR
      run: |
        chmod +x ros-dpbr.sh
        ./ros-dpbr.sh
        
    - name: Verify generated RSC files
      run: |
        echo "ğŸ” æ£€æŸ¥ç”Ÿæˆçš„RSCæ–‡ä»¶:"
        ls -la *.rsc || echo "æœªæ‰¾åˆ°.rscæ–‡ä»¶"
        for file in CN.rsc CMCC.rsc CT.rsc; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo 0)
            echo "âœ… $file: $lines è¡Œ"
          else
            echo "âŒ $file: æ–‡ä»¶ä¸å­˜åœ¨"
          fi
        done

    - name: Commit & Push changes
      if: github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        git add *.rsc
        if git diff --staged --quiet; then
          echo "ğŸ“­ æ— RSCæ–‡ä»¶å˜æ›´"
        else
          git commit -m "ğŸ¤– Auto-update PBR rules"
          git push
        fi

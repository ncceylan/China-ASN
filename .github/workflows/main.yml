name: Run ASN Script

on: [push, pull_request]

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Debug initial directory
      run: |
        echo "ğŸ“ åˆå§‹å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ“ åˆå§‹æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "ğŸ“ scriptsç›®å½•å†…å®¹:"
        ls -la scripts/ || echo "scriptsç›®å½•ä¸å­˜åœ¨"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml

    - name: Run ASN script with debug
      run: |
        echo "ğŸ“ è¿è¡Œè„šæœ¬å‰ç›®å½•: $(pwd)"
        python scripts/ASN.py

    - name: Check generated files
      run: |
        echo "ğŸ“ è„šæœ¬è¿è¡Œåç›®å½•: $(pwd)"
        echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -la *.conf 2>/dev/null || echo "æœªæ‰¾åˆ°.confæ–‡ä»¶"
        
        # è¯¦ç»†æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶
        for file in asn_cn.conf asn_ct.conf asn_cmcc.conf; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
            echo "å†…å®¹é¢„è§ˆ:"
            head -5 "$file" 2>/dev/null || echo "æ–‡ä»¶ä¸ºç©ºæˆ–æ— è¯»å–æƒé™"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
          fi
        done

    - name: Debug directory structure
      run: |
        echo "ğŸŒ³ å®Œæ•´ç›®å½•ç»“æ„:"
        find . -name "*.conf" -o -name "ASN.py" | sort

    - name: Commit changes if on main branch
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ” æ£€æŸ¥gitçŠ¶æ€:"
        git status
        
        echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´:"
        git diff --name-only
        
        # æ·»åŠ æ‰€æœ‰.confæ–‡ä»¶
        git add *.conf 2>/dev/null || echo "æ— .confæ–‡ä»¶å¯æ·»åŠ "
        
        if git diff --staged --quiet; then
          echo "ğŸ“­ æ— å˜æ›´éœ€è¦æäº¤"
        else
          echo "ğŸ“¬ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          git commit -m "ğŸ¤– Auto-update ASN data"
          git push
        fi

name: Run ASN Script

on: [push, pull_request]

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•ä»¥æ£€æµ‹å˜æ›´

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml

    - name: Run ASN script
      run: |
        python scripts/ASN.py

    - name: Check for file changes
      id: changes
      run: |
        # æ£€æŸ¥ASNæ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ˜¯å¦æœ‰å†…å®¹å˜æ›´
        if git diff --name-only HEAD~1 | grep -E '(asn_cn\.conf|asn_ct\.conf|asn_cmcc\.conf)' || \
           [ ! -f "asn_cn.conf" ] || [ ! -f "asn_ct.conf" ] || [ ! -f "asn_cmcc.conf" ]; then
          echo "ASN files changed or missing"
          echo "changes=true" >> $GITHUB_OUTPUT
        else
          echo "No changes in ASN files"
          echo "changes=false" >> $GITHUB_OUTPUT
        fi

    - name: List generated files
      run: |
        echo "ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la *.conf 2>/dev/null || echo "æœªæ‰¾åˆ°.confæ–‡ä»¶"
        for file in asn_cn.conf asn_ct.conf asn_cmcc.conf; do
          if [ -f "$file" ]; then
            count=$(wc -l < "$file" || echo 0)
            echo "ðŸ“„ $file: $count è¡Œ"
          else
            echo "âŒ $file: æ–‡ä»¶ä¸å­˜åœ¨"
          fi
        done

    - name: Commit and push changes (main branch only)
      if: steps.changes.outputs.changes == 'true' && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        git add *.conf
        git commit -m "ðŸ¤– Auto-update ASN data"
        git push

    - name: Upload ASN files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: asn-data
        path: |
          asn_*.conf
        retention-days: 30
